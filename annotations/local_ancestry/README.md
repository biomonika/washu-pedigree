# Local ancestry of WashU pedigree samples

We used [flare](https://github.com/browning-lab/flare) (`v0.5.0, 05Jan24.e0b`; [Browning et al. 2023](http://dx.doi.org/10.1016/j.ajhg.2022.12.010)) to estimate the local ancestry of assembly haplotypes for each of the WashU pedigree samples.

## Overview

For local ancestry inference, we used:

- Phased variant calls for each individual
    - Generated by using [`dipcall`](https://github.com/lh3/dipcall) to call variants from each haplotype against CHM13 v2.0
- `dip.bed` files from `dipcall`, indicating "confident" regions that have the expected 1:1 alignment between the assembly and reference
- Phased variant calls from a reference panel
    - [1000 Genomes phased VCFs called on CHM13 v2.0](https://s3-us-west-2.amazonaws.com/human-pangenomics/index.html?prefix=T2T/CHM13/assemblies/variants/1000_Genomes_Project/chm13v2.0/) (Rhie et al. 2023)
    - AFR ancestry reference panel: ESN, GWD, LWK, MSL, and YRI populations
    - EUR ancestry reference panel: CEU, FIN, GBR, IBS, and TSI populations
- [Recombination (genetic) map for CHM13 v2.0](https://zenodo.org/records/14891074) (Lalli et al. 2025)
- CHM13v2.0->assembly chain files and assembly fasta files for each assembled haplotype, used to lift over CHM13-based local ancestry coordinates to assembly-based coordinates

## 1. Pre-processing input data

### 1.1. `01_prep_1kgp_vcfs.sh`

This script prepares the phased CHM13v2.0 1KGP VCFs by splitting multiallelic sites, removing unphased sites, and generating a dummy VCF with all samples besides one removed, which is used in the next step.

Inputs:
- `KGP`: Directory of 1KGP VCFs
- `OUTDIR`: Output directory for processed 1KGP VCFs
- `SUBSET`: Output directory for dummy VCFs with all samples besides one removed

### 1.2. `02_merge_dipcall_1kgp.sh`

This script prepares the dipcall VCFs by:

- Merging them with the 1KGP dummy VCFs, such that all 1KGP sites not called in the dipcall VCFs are assumed to be reference (`0/0`)
- Keeping only 1KGP sites
- Running a separate script `edit_PAN011_vcf.R` to create false homozygous chrX genotypes for PAN011, who is XY
- Removing variants with missing genotypes and multi-allelic sites
- Phasing `0/0` genotypes to `0|0`

Inputs:
- `RAW_WASHU`: Directory of raw dipcall VCFs
- `SUBSET`: Directory of dummy 1KGP VCFs with all samples besides one removed
- `WASHU`: Output directory for processed dipcall VCFs
- `editPAN011Script`: Script for editing PAN011 chrX genotypes (provided in `supp_scripts` directory)

### 1.3. `03_edit_genetic_map.sh`

Edits the CHM13 v2.0 genetic map files to convert them into flare format.

Inputs:
- `MAP`: Directory of raw genetic map files

### 1.4. `04_make_exclude_files.sh`

This script creates a list of sites to exclude from local ancestry inference. We exclude all sites that are not in the `dip.bed` files from dipcall, and create additional exclude files so that we can run local ancestry inference separately on the chrX PAR (recombining) and non-PAR (non-recombining) regions.

Exclude files for the chrX non-PAR regions list sites in PAR1 and PAR2. Exclude files for the PARs list sites not in the PAR.

Inputs:
- `vcfDir`: Directory of processed dipcall VCFs
- `kgpDir`: Directory of dummy 1KGP VCFs with all samples besides one removed
- `bedDir`: Directory of `dip.bed` files
- `excludeDir`: Output directory for exclude files
- `sample`: Name of sample to run on

## 2. Local ancestry inference with `flare`

### 2.1. `05_flare_slurm.sh`

Runs a `flare` array job across all samples. For most samples, following [recommendations from the flare GitHub](https://github.com/browning-lab/flare?tab=readme-ov-file#running-flare-with-multiple-chromosomes), we first run flare only on chr1 to infer the demographic model and then re-use that model for the other chromosomes. For PAN010, where the chr1 model did not converge for other chromosomes (possibly because it inferred all-AFR ancestry for chr1), we inferred the demographic model separately for all chromosomes.

Inputs:
- `MANIFEST`: List of samples to run on
- `FLARE`: Path to flare binary
- `KGP`: Directory of processed 1KGP VCFs
- `PANEL`: Path to table of reference panel samples for each ancestry (uploaded to the `reference_data` directory)
- `WASHU`: Directory of processed dipcall VCFs
- `MAP`: Directory of genetic map files
- `EXCLUDE_PATH`: Directory of exclude files
- `OUTDIR`: Output directory for flare results

### 2.2. `06_flare_chrX_slurm.sh`

Runs flare on chrX in two parts: 1) On the non-PAR region, using only XX samples in the reference panel and inferring a new demographic model, and 2) On PAR1 and PAR2, using the full reference panel and chr1 demographic model.

Inputs:
- `MANIFEST`: List of samples to run on
- `FLARE`: Path to flare binary
- `KGP`: Directory of processed 1KGP VCFs
- `WASHU`: Directory of processed dipcall VCFs
- `MAP`: Directory of genetic map files
- `PANEL`: Path to table of XX reference panel samples for each ancestry (uploaded to the `reference_data` directory)
- `EXCLUDE`: Path to exclude file
- `OUTDIR`: Output directory for flare results

## 3. Post-processing `flare` output

### 3.1. `07_liftover_ancestry.sh`

Lifts over `flare` local ancestry results from CHM13 v2.0 coordinates to the coordinates of each assembled haplotype. The script edits the liftover chain files and assembly fastas to remove assembly-specific prefixes, and then performs liftover.

`flare` outputs local ancestry in VCF format, where variants are assigned a probability of belonging to each ancestry on a haplotype-specific basis (i.e., every variant receives two ancestry probabilities - one for each haplotype). Because each haplotype has its own assembly coordinates, I lifted over every VCF twice - once onto each haplotype.

Inputs:
- `liftOver`: Path to UCSC liftover binary
- `chainPath`: Directory of chain files between CHM13 and sample assemblies
- `assemblyPath`: Directory of sample- and haplotype-specific assembly fastas
- `flarePath`: Directory of flare output VCFs
- `flareOutPath`: Output directory for lifted over flare VCFs

### 3.2. `08_process_and_plot_ancestry.R`

This script merges ancestry calls from the lifted-over `flare` VCFs into bed files, and plots local ancestry by chromosome.

The first part of the script parses the genotype column with ancestry information to keep only one of the haplotypes (since we lifted over onto coordinates for both haplotypes). It also converts site-specific ancestry probabilities into "ranges," extending the ancestry probability for one SNP so that it covers the interval between that SNP and the next. Finally, it merges adjacent intervals with the same ancestry probability to create larger regions.

The last part of the script plots local ancestry tracts by chromosome, with optional censat annotations.

Inputs:
- `sample`: Name of sample to run on
- `hap_names`: Names of sample haplotypes
- `flare_path`: Path to lifted over flare VCFs
- `assembly_dir`: Directory of assembly `.fai`s (to get chromosome lengths) and censat annotations (optional)